<ion-header>
  <ion-toolbar color="primary" *ngIf="checked.length == 0">
    <ion-buttons slot="start">
      <ion-button (click)="backViewPlan()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
      <!-- <ion-back-button [defaultHref]="isDisabled ? '/tabs/plans' : '/tabs/plans/editplan/details.id'"></ion-back-button> -->
    </ion-buttons>
    <ion-title>
      {{details.planName}}
    </ion-title>

    <ion-buttons slot="end">
      <!-- {{isDisabled ? 'Edit' : 'Save'}} -->
      <ion-button *ngIf="isDisabled" (click)="popOverController($event)">
        <ion-icon ios="ios-more" md="md-more" *ngIf="isDisabled"></ion-icon>
      </ion-button>
      <ion-button *ngIf="!isDisabled" (click)="savePage(details.id)">
        Save
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar color="greenCard" *ngIf="checked.length > 0">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="" (tap)="clearArray()"></ion-back-button>
      <span> {{checked.length}} </span>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-icon name="trash" style="font-size: 24px; margin-right:14px;" (tap)="deleteArray()"></ion-icon>
    </ion-buttons>
  </ion-toolbar>

</ion-header>


<!-- Test my data yong rui -->
<style>
  .imgCircle {
    float: left;
    border-radius: 50%;
    width: 50%;
    height: 100%;
    padding: 4%;
    /* background-color:#000000 !important; */
    /* border: 1px solid black;  */
  }

  .imgCircleText {
    /* height:100%; */
    /* margin:16px; */
    white-space: normal;
    text-align: left;
    margin-top: 12%;
    /*FIXME: https://ionicframework.com/docs/v3/theming/css-utilities/ */
  }

  /* 
  ion-content{
    --ion-background-color:grey;
  } */

  ion-card {
    border-radius: 16px;
    background-color: white;
    color: black;
    /* text */
    margin-top: 6%;
  }

  ion-grid {
    background-color: #d3d3d3;
  }

  .btnAdd {
    margin-top: 18px !important;
  }

  .blur {
    filter: blur(15px);
    -webkit-filter: blur(15px);
    opacity: 1;
    background-color: #FFF;
    transition: -webkit-filter 200ms linear;
    height: 100%;
    width: 100%;
    position: absolute;
  }

  .blurTitle {

    filter: blur(15px);
    -webkit-filter: blur(15px);
    /* transition: -webkit-filter 200ms linear; */
  }

  /* .highlight{
    background-color: #1ebea5;
  } */

  ion-content {
    --padding-start: 4px;
    --padding-end: 4px;
  }

  /* ion-grid{
    width: 100vw;
    margin-left: calc(-50vw + 50%);
  } */
  ion-card-title {
    color: white;
    font-weight: bold;
    font-size: 1.1em;
    padding: 0;
    margin: 0 4px;
  }

  ion-textarea {
    margin: 0;
  }

  /* .yellowItem {
    --border-width: 0px;
    --inner-padding-end: 0;
    --padding-start: 0;
  }

  .gridReplace {
    background-color: #d3d3d3;
    padding-top: 6%;
    padding-bottom: 3%;
  } */

  #Html2PDF {
    padding-bottom: 20px;
  }
  .dateTimePadding {
    --inner-padding-end: 0px;
    --inner-padding-top: 0px;
  }
  ion-item{
    --min-height:0px;
  }
</style>

<!--ADD LONG PRESS https://forum.ionicframework.com/t/how-to-select-multiple-item-on-long-press/67456/2 -->
<ion-content padding>
  <div id="Html2PDF">

    <ion-card class="welcome-card">
      <ion-card-header color="tertiary">
        <ion-card-title>Plan Details</ion-card-title>
      </ion-card-header>

      <ion-card-content>

  <form [formGroup]="something">
      <ion-row>
        <ion-col>
          <ion-item no-padding>
            <ion-label position="floating"> Name </ion-label>
            <ion-input formControlName="detailname" type="text" [(ngModel)]="details.name" readonly="{{isDisabled}}"
              [class.invalid]="!something.controls.detailname.valid && (something.controls['detailname'].dirty)">
            </ion-input>
          </ion-item>
          <p *ngIf="!something.controls.detailname.valid &&submitted" style="color:red">Name required</p>
        </ion-col>
        <ion-col>
          <ion-item no-padding>
            <ion-label position="floating"> NRIC </ion-label>
            <ion-input formControlName="detailnric" type="text" [(ngModel)]="details.nric" readonly="{{isDisabled}}"
              [class.invalid]="!something.controls.detailnric.valid && (something.controls['detailnric'].dirty)">
            </ion-input>
          </ion-item>
          <p *ngIf="!something.controls.detailnric.valid  &&submitted" style="color:red">Invalid NRIC</p>
        </ion-col>
      </ion-row>
      <ion-row>
        <ion-col>
          <ion-item no-padding>
            <ion-label position="floating"> TCS Name </ion-label>
            <ion-input formControlName="detailtcs" type="text" [(ngModel)]="details.cname" readonly="{{isDisabled}}"
              [class.invalid]="!something.controls.detailtcs.valid && (something.controls['detailtcs'].dirty)">
            </ion-input>
          </ion-item>
          <p *ngIf="!something.controls.detailtcs.valid &&submitted" style="color:red">TCS name required</p>
        </ion-col>
        <ion-col>
          <ion-item no-padding>
            <ion-label position="floating"> TCS Contact </ion-label>
            <ion-input formControlName="detailcontact" type="text" [(ngModel)]="details.ccontact" readonly="{{isDisabled}}"
              [class.invalid]="!something.controls.detailcontact.valid && (something.controls['detailcontact'].dirty)">
            </ion-input>
          </ion-item>
          <p *ngIf="!something.controls.detailcontact.valid &&submitted" style="color:red">Invalid Contact</p>
        </ion-col>
      </ion-row>

    </form>
      </ion-card-content>
    </ion-card>



    <!-- Test my data yong rui -->
    <ion-card *ngFor="let globalItem of frontViewData;">
      <ion-card-header [color]="globalItem.colorCard">
        <ion-card-title>
          {{globalItem.textCard}}
        </ion-card-title>

        <ion-content>
          <ion-fab vertical="top" horizontal="end" edge slot="fixed" *ngIf="!isDisabled">
            <!-- <ion-fab-button size="small" (click)="addNewCriticalArray('Critical')" class="btnAdd" color="redCard"> -->
            <ion-fab-button size="small" class="btnAdd" (click)="globalItem.toggle=!globalItem.toggle"
              [disabled]="checked.length > 0">
              <ion-icon name="{{!globalItem.toggle ? 'md-add' : 'md-close'}}"></ion-icon>
            </ion-fab-button>
          </ion-fab>
        </ion-content>

      </ion-card-header>

    <ion-row style="background-color: grey; color: white;">
      <ion-col>
        <span style="margin-left: 10%"> Symptom </span>
      </ion-col>
      <ion-col>
        <span style="margin-left: 6%;"> What to do </span>
      </ion-col>
    </ion-row>
      <!-- view page when click on one template... show icon and text only -->
      <!-- <ion-grid style="padding:3%; background-color: #FFF" *ngIf="viewPage && !editPage"> -->
      <ion-grid style="padding:3%; background-color: #FFF" *ngIf="isDisabled">
        <ion-row *ngFor="let item of getArray(globalItem.id)">

          <ion-col size="6">
            <img class="imgCircle" [src]="item.symptom.img" onError="this.src='assets/empty.svg'"/>
            <p class="imgCircleText"> {{item.symptom.description == "" ? item.symptom.text : item.symptom.description}}
            </p>
          </ion-col>

          <ion-col size="6" *ngIf="item.combined.length == 0" style="border-left: 2.5px solid #d3d3d3"></ion-col>

          <ng-container *ngFor="let x of item.combined; let actIndex = index;">
            <ion-col size="6" *ngIf="actIndex != 0"></ion-col>
            <ion-col size="6" style="border-left: 2.5px solid #d3d3d3">
              <img class="imgCircle" [src]="x.img" onError="this.src='assets/empty.svg'"/>
              <p class="imgCircleText"> {{x.description == "" ? x.text : x.description}} </p>
            </ion-col>
          </ng-container>

        </ion-row>

        <ion-row style="height:45px;" [ngClass]="{'blur': globalItem.toggle}" *ngIf="!checkType(globalItem.id)">
          <p text-center style="width:100%"> No symptoms and actions added </p>
        </ion-row>

      </ion-grid>


      <div class="gridReplace" *ngIf="!isDisabled">

        <ion-row *ngFor="let item of getArray(globalItem.id); let i = index;" style="border-bottom: 2px solid #A9A9A9"
          [ngClass]="{'blur': globalItem.toggle}">

          <!-- first column aka symptom -->
          <ion-col [size]="checked.length > 0 ? 5.25 : 6"
            [ngClass]="{'highlight': item.combined[0]?.whatsapp && checked.length > 0}"
            (press)="pressEvent('Symptom', item, globalItem.id, i);"
            (click)="checked.length > 0 && clickEvent('Symptom', item, globalItem.id, i)">
            <ion-card (click)="checked.length == 0 && presentActionSheet('Symptom', item, globalItem.id)"
              [ngClass]="{'highlight' : item.combined[0]?.whatsapp && checked.length > 0}">
              <img class="imgCircle" [src]="item.symptom.img" onError="this.src='assets/empty.svg'"/>
              <!-- https://stackoverflow.com/questions/45263542/ngmodel-value-in-img-src-ionic-3 -->
              <p class="imgCircleText"> {{item.symptom.text}} </p>
            </ion-card>
            <ion-card>
              <ion-item no-padding class="yellowItem">
                <ion-textarea rows="4" placeholder="Describe the symptom in more details."
                  [readonly]="item.combined[0]?.whatsapp" [(ngModel)]="item.symptom.description"
                  [ngClass]="{'highlight': item.combined[0]?.whatsapp && checked.length > 0}" (ionFocus)="inputFocus()">
                </ion-textarea>
              </ion-item>
            </ion-card>
          </ion-col>

          <!-- for each second column aka action -->
          <ng-container *ngFor="let x of item.combined; let actIndex = index;">

            <ion-col [size]="checked.length > 0 ? 5.25 : 6" [ngClass]="{'highlight': x.whatsapp && checked.length > 0}"
              (press)="pressEvent('Action', x, globalItem.id, i)"
              (click)="checked.length > 0 && clickEvent('Action', x, globalItem.id, i)" *ngIf="actIndex != 0"></ion-col>

            <ion-col [size]="checked.length > 0 ? 5.25 : 6" [ngClass]="{'highlight': x.whatsapp && checked.length > 0}"
              (press)="actIndex == 0 ? pressEvent('Symptom', item, globalItem.id, i) : pressEvent('Action', x, globalItem.id, i);"
              (click)="checked.length > 0 && clickEvent('Action', x, globalItem.id, i)">

              <ion-card (click)="checked.length == 0 && presentActionSheet('Action', x)"
                [ngClass]="{'highlight': x.whatsapp && checked.length > 0}">
                <img class="imgCircle" [src]="x.img" onError="this.src='assets/empty.svg'"/>
                <p class="imgCircleText"> {{x.text}}</p>
              </ion-card>

              <ion-card>
                <ion-item no-padding class="yellowItem">
                  <ion-textarea rows="4" placeholder="Describe the required action in your own words."
                    [readonly]="x.whatsapp" [(ngModel)]="x.description"
                    [ngClass]="{'highlight': x.whatsapp && checked.length > 0}" (ionFocus)="inputFocus()">
                  </ion-textarea>
                </ion-item>
              </ion-card>

            </ion-col>

            <ion-col size="1.5" *ngIf="checked.length > 0" [ngClass]="{'highlight': x.whatsapp}"
              (click)="clickEvent('Action', x, globalItem.id, i)">
              <ion-checkbox [checked]="x.whatsapp" mode="ios" color="success"></ion-checkbox>
            </ion-col>

          </ng-container>

        </ion-row>

        <ion-row style="height:150px;" [ngClass]="{'blur': globalItem.toggle}" *ngIf="!checkType(globalItem.id)">
        </ion-row>


        <ng-container *ngIf="globalItem.toggle">
          <!--https://stackoverflow.com/questions/28975673/how-to-blurcss-div-without-blur-child-element/29249483-->
          <ion-row (click)="globalItem.toggle=!globalItem.toggle; addNewCriticalArray(globalItem.type, globalItem.id)">
            <ion-col size="4">
              <ion-fab-button [color]="globalItem.colorBtn" style="float:right">
                <ion-icon name="add"></ion-icon>
              </ion-fab-button>
            </ion-col>
            <ion-col size="8">
              <ion-label class="addLabel"> Add symptom</ion-label>
              <br>
              <ion-label class="addLabelTwo"> and action </ion-label>
            </ion-col>
          </ion-row>

          <ion-row *ngIf="checkType(globalItem.id)"
            (click)="globalItem.toggle=!globalItem.toggle; popUp(globalItem.id);">
            <ion-col size="4">
              <ion-fab-button [color]="globalItem.colorBtn" style="float:right">
                <ion-icon name="add"></ion-icon>
              </ion-fab-button>
            </ion-col>
            <ion-col size="8">
              <ion-label class="addLabel"> Add action</ion-label>
            </ion-col>
          </ion-row>
        </ng-container>

      </div>

    </ion-card>



    <ion-card class="welcome-card" style="margin-bottom: 6%">
      <ion-card-header color="tertiary">
        <ion-card-title>
          Appointment (Optional)
        </ion-card-title>
        <ion-content>
          <ion-fab vertical="top" horizontal="end" edge slot="fixed">
            <ion-fab-button (click)="newAppt()" size="small" class="btnAdd" [disabled]="checked.length > 0" *ngIf="!isDisabled">
                <ion-icon name="add"></ion-icon>
              </ion-fab-button>
        </ion-fab>
        </ion-content>
      </ion-card-header>
      
      <div class="gridReplace" style="background-color:white;">
        <ion-row *ngIf="checkAppt()">
          <ion-col>
            <ion-label>Clinic Name</ion-label>
          </ion-col>
          <ion-col>
            <ion-label>Date</ion-label>
          </ion-col>
        </ion-row>
        <ion-row *ngFor="let info of getApptArray(); let apptIndex = index;" [ngClass]="{'highlight': info.whatsapp && checked.length > 0}"
          (press)="pressEvent('appt', info, 4, apptIndex)">

          <ion-col [size]="checked.length > 0 ? 5.25 : 6" (click)="checked.length > 0 && clickEvent('appt', info, 4, apptIndex)">
            <ion-item no-padding [ngClass]="{'yellowItem': info.whatsapp && checked.length > 0}" [lines]="isDisabled && 'none'">
              <ion-textarea rows="1" autoGrow="true" [(ngModel)]="info.clinicName" placeholder="Name of clinic" [ngClass]="{'highlight': info.whatsapp && checked.length > 0}"
              [readonly]="isDisabled || checked.length > 0"></ion-textarea>
            </ion-item>
          </ion-col>

          <ion-col [size]="checked.length > 0 ? 5.25 : 6" [ngClass]="{'highlight': info.whatsapp && checked.length > 0}"
            (click)="checked.length > 0 && clickEvent('appt', info, 4, apptIndex)">
            <ion-item no-padding [ngClass]="{'yellowItemForDateTime': info.whatsapp && checked.length > 0}" [lines]="isDisabled && 'none'">
              <ion-datetime placeholder="day/month/year hour:min" #mypicker [readonly]="isDisabled || checked.length > 0"
                (ionChange)="dateChanged(mypicker.value,info)" display-format="DD/MMM/YY h:mm A" min="2017" [(ngModel)]="info.appTime"
                max="2022" text-wrap no-padding [ngClass]="{'highlight': info.whatsapp && checked.length > 0}">
              </ion-datetime>
            </ion-item>
          </ion-col>

          <ion-col size="1.5" *ngIf="checked.length > 0"  [ngClass]="{'highlight': info.whatsapp}" (click)="checked.length > 0 && clickEvent('appt', info, 4, apptIndex)">
            <ion-checkbox [checked]="info.whatsapp" mode="ios" color="success"></ion-checkbox>
          </ion-col>

        </ion-row>

        <ion-row style="height:45px;" *ngIf="!checkAppt()"> 
            <p text-center style="width:100%"> No appointments added </p>
        </ion-row>


      </div>

    </ion-card>


  </div>
</ion-content>